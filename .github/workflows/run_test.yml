name: Run Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  tests:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install .

      - name: Run Tests With Coverage
        run: |
          pytest -m "not localonly" --cov=my_package --cov-report=term --cov-report=xml

      - name: Extract Coverage Percentage
        id: coverage
        run: |
          # Extract total line coverage as an integer (e.g., 82)
          COVERAGE=$(grep -Po 'line-rate="\K[0-9.]+' coverage.xml | awk '{printf "%.0f", $1*100}')
          echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT

      - name: Generate Coverage Badge
        run: |
          COV=${{ steps.coverage.outputs.coverage }}
          COLOR=red
          if [ $COV -ge 90 ]; then COLOR=brightgreen; fi
          if [ $COV -ge 75 ] && [ $COV -lt 90 ]; then COLOR=yellow; fi

          cat > coverage.svg <<EOF
          <svg xmlns="http://www.w3.org/2000/svg" width="120" height="20">
            <linearGradient id="a" x2="0" y2="100%">
              <stop offset="0" stop-color="#bbb" stop-opacity=".1"/>
              <stop offset="1" stop-opacity=".1"/>
            </linearGradient>
            <rect rx="3" width="120" height="20" fill="#555"/>
            <rect rx="3" x="60" width="60" height="20" fill="$COLOR"/>
            <path fill="$COLOR" d="M60 0h4v20h-4z"/>
            <rect rx="3" width="120" height="20" fill="url(#a)"/>
            <g fill="#fff" text-anchor="middle" font-family="Verdana" font-size="11">
              <text x="30" y="14">coverage</text>
              <text x="90" y="14">${COV}%</text>
            </g>
          </svg>
          EOF

      - name: Generate Coverage Badge for Documentation
        run: |
          COV=${{ steps.coverage.outputs.coverage }}
          COLOR=red
          if [ $COV -ge 90 ]; then COLOR=brightgreen; fi
          if [ $COV -ge 75 ] && [ $COV -lt 90 ]; then COLOR=yellow; fi

          cat > docs/source/assets/coverage.svg <<EOF
          <svg xmlns="http://www.w3.org/2000/svg" width="120" height="20">
            <linearGradient id="a" x2="0" y2="100%">
              <stop offset="0" stop-color="#bbb" stop-opacity=".1"/>
              <stop offset="1" stop-opacity=".1"/>
            </linearGradient>
            <rect rx="3" width="120" height="20" fill="#555"/>
            <rect rx="3" x="60" width="60" height="20" fill="$COLOR"/>
            <path fill="$COLOR" d="M60 0h4v20h-4z"/>
            <rect rx="3" width="120" height="20" fill="url(#a)"/>
            <g fill="#fff" text-anchor="middle" font-family="Verdana" font-size="11">
              <text x="30" y="14">coverage</text>
              <text x="90" y="14">${COV}%</text>
            </g>
          </svg>
          EOF

      - name: Commit Coverage Badge
        if: github.ref == 'refs/heads/main'
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add coverage.svg
          git commit -m "Update coverage badge to ${{ steps.coverage.outputs.coverage }}%" || echo "No changes to commit."

      - name: Push Changes
        if: github.ref == 'refs/heads/main'
        uses: ad-m/github-push-action@v0.8.0
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
